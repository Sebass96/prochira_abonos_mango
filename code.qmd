---
title: "ABONOS ORGÁNICOS EN LA CALIDAD Y MANEJO POSTCOSECHA DE MANGO (Mangifera indica L). VAR. KENT"
format:
  html:
    toc: true
    toc-location: left
    number-sections: true
    self-contained: true
    output-file: "ESM_1"
editor_options: 
  chunk_output_type: console
execute: 
  warning: false
  echo: true
---

# Setup

Instalar version en desarrollo.

```{r}
#| eval: false

if (!require("remotes"))
  install.packages("remotes")
remotes::install_github("flavjack/inti")
```

```{r}
#| label:  setup

library(emmeans)
library(corrplot)
library(multcomp)
library(FSA)
library(factoextra)
library(corrplot)
library(png)
source('https://inkaverse.com/setup.r')

# library(rstatix)
# library(dlookr)
# library(car)

session_info()
```

# References

- (PCA) https://www.r-bloggers.com/2017/07/pca-course-using-factominer/
- (PCA) https://www.youtube.com/watch?v=Uhw-1NilmAk&ab_channel=Fran%C3%A7oisHusson
- (HCPC) https://youtu.be/EJqYTDTJJug

# Import data

```{r}
url <- "https://docs.google.com/spreadsheets/d/1cjWrS-EVcII85c-l_NuEfTpjhVMI156e8REM9GDVP_w/edit?gid=95386135#gid=95386135"

gs <- url %>% 
  as_sheets_id()

tratamiento <- gs %>% 
  range_read("tratamientos") %>% 
  rename_with(~ tolower(.))

rendimiento <- gs %>% 
  range_read("rendimiento") %>% 
  rename_with(~ tolower(.)) 

fisio <- gs %>% 
  range_read("fisio") %>% 
  rename_with(~ tolower(.)) %>% 
  merge(., tratamiento) %>% 
  dplyr::select(tratamiento,compost, biol,everything()) %>% 
  merge(., rendimiento) %>% 
  mutate(across(tratamiento:nfrutos, ~ as.factor(.))) %>% 
  rename(treat = tratamiento
         , repetition = repeticion
         , composts = compost)

str(fisio)

consumo <- gs %>% 
  range_read("consumo") %>% 
  rename_with(~ tolower(.)) %>%
  merge(., tratamiento) %>% 
  dplyr::select(tratamiento,compost, biol,everything()) %>% 
  mutate(across(tratamiento:nfrutos, ~ as.factor(.))) %>% 
    rename(treat = tratamiento
         , repetition = repeticion
         , composts = compost
         , n_fruits = nfrutos)

glimpse(consumo)
```

# Data summary

```{r}
sm <- fisio %>% 
  group_by(treat) %>% 
  summarise(across(pcfmf:rpp, ~ sum(!is.na(.))))

sm

sm <- consumo %>% 
  group_by(treat) %>% 
  summarise(across(pdfmc:imf, ~ sum(!is.na(.))))

sm
```

# Objetivos

- Mostrar  el efecto de los abonos orgánicos compost y biol en la calidad del fruto de mango en madurez fisiológica

- Mostrar  el efecto de los abonos orgánicos compost y biol en la calidad del fruto de mango en madurez comercial

## Objetivo Específico 1

> Mostrar  el efecto de los abonos orgánicos compost y biol en la calidad del fruto de mango en madurez fisiológica

### Fruit firmness at physiological maturity (FFPM)

```{r}
trait <- "ffmf"
fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1a <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit firmness at physiological maturity (kgf.cm^{-2})"
           , glab = "Biol"
           , ylimits = c(0, 16, 4)
           )

p1a
```

###  Internal fruit color at physiological maturity (IFCPM).

> Excluir esta variable como cuantitativo

```{r}
trait <- "cifmf"
fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1b <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Internal fruit color at physiological maturity"
           , ylimits = c(0, 3, 1)
           )

p1b
```

### Fruit pH at physiological maturity  (FpHPM)

```{r}
trait <- "phfmf"
fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1c <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "pH del Fruto"
           , ylimits = c(0, 4, 1)
           )

p1c
```

### Soluble solids content of the fruit at physiological maturity (SSCFPM)

```{r}
trait <- "ssfmf"
fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1d <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Soluble solids content of the fruit at physiological maturity (brix^{o})"
           , ylimits = c(0, 12, 2)
           )

p1d
```

### Titratable acidity of the fruit at physiological maturity (TAFPM)

```{r}
trait <- "atfmf"
fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1e <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Titratable acidity of the fruit at physiological maturity ('%')"
           , ylimits = c(0, 2, 1)
           )

p1e
```

### Fruit dry matter percentage at physiological maturity (FDMPPM)

```{r}
trait <- "msfmf"
fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1f <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit dry matter at physiological maturity ('%')"
           , ylimits = c(0, 25, 5)
           )

p1f
```

### Figure 1

```{r}
legend <- cowplot::get_plot_component(p1a, 'guide-box-top', return_all = TRUE)

p1 <- list(p1a + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           # , p1b + labs(x = NULL) + theme(legend.position="none"
           #                              , axis.title.x=element_blank()
           #                              , axis.text.x=element_blank()
           #                              , axis.ticks.x=element_blank())
           # , p1c + labs(x = NULL) + theme(legend.position="none"
           #                              , axis.title.x=element_blank()
           #                              , axis.text.x=element_blank()
           #                              , axis.ticks.x=element_blank())
           , p1d + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1e + theme(legend.position="none")
           , p1f + theme(legend.position="none")
           ) %>% 
  plot_grid(plotlist = ., ncol = 2
            , labels = "auto"
            ) 

fig <- plot_grid(legend, p1, ncol = 1, align = 'v', rel_heights = c(0.05, 1))
  
fig %>% 
  ggsave2(plot = ., "files/Fig-1.jpg"
         , units = "cm"
         , width = 25
         , height = 27
         )

fig %>% 
  ggsave2(plot = ., "files/Fig-1.eps"
         , units = "cm"
         , width = 25
         , height = 27
         )

knitr::include_graphics("files/Fig-1.jpg")
```

### Multivariate

```{r}
mv <- fisio %>% 
  group_by(composts, biol) %>% 
  summarise(across(where(is.numeric), ~ mean(., na.rm = T))) %>%   
  unite("treat", composts:biol, sep = "-") %>% 
  rename(Treat = treat
         ,PFCCPM = pcfmf
         ,FFPM = ffmf
         ,IFCPM = cifmf
         ,SSCFPM = ssfmf
         ,FpHPM = phfmf
         ,TAFPM = atfmf
         ,FDMPPM = msfmf
         ,FPMI = imf
         ,RPP = rpp)
   
pca <- mv %>% 
  PCA(scale.unit = T, quali.sup = 1, graph = F) 

# summary

summary(pca, nbelements = Inf, nb.dec = 2)


f2a <- plot.PCA(x = pca, choix = "var"
                , cex=0.8
                )

f2b <- plot.PCA(x = pca, choix = "ind"
                , habillage = 1
                , invisible = c("ind")
                , cex=0.8
                , ylim = c(-3,3)
                ) 

```

### Figure 2

```{r}
fig <- list(f2a, f2b) %>% 
  plot_grid(plotlist = ., ncol = 2, nrow = 1
            , labels = "auto"
            , rel_widths = c(1, 1.5)
            )
fig %>% 
  ggsave2(plot = ., "files/Fig-2.jpg", units = "cm"
         , width = 25
         , height = 10
         )
fig %>% 
  ggsave2(plot = ., "files/Fig-2.eps", units = "cm"
         , width = 25
         , height = 10
         )

knitr::include_graphics("files/Fig-2.jpg")
```

### Principal components

```{r}
var <- get_pca_var(pca)

tmp <- tempfile(fileext = ".png")
ppi <- 300
png(tmp, width=8*ppi, height=10*ppi, res=ppi)
corrplot(var$cor, 
         method="number",
         tl.col="black", 
         tl.srt=45,)
graphics.off()

pt1 <- png::readPNG(tmp) %>%
  grid::rasterGrob(interpolate = TRUE)

pt2 <- fviz_eig(pca, 
                addlabels=TRUE,
                hjust = 0.05,
                barfill="white",
                barcolor ="darkblue",
                linecolor ="red") + 
  ylim(0, 90) + 
  labs(
    title = "PCA - percentage of explained variances",
    y = "Variance (%)") +
  theme_minimal()

pt3 <- fviz_contrib(pca,
                     choice = "var", 
                     axes = 1, 
                     top = 10,
                     fill="white",
                     color ="darkblue",
                     sort.val = "desc") +
  ylim(0, 15) + 
  labs(title = "Dim 1 - variables contribution") 

pt4 <- fviz_contrib(pca,
                     choice = "var", 
                     axes = 2, 
                     top = 10,
                     fill="white",
                     color ="darkblue",
                     sort.val = "desc") +
  ylim(0, 80) + 
  labs(title = "Dim 2 - variables contribution") 

plot <- ggdraw(xlim = c(0.0, 1.0), ylim = c(0, 1.0))+
  draw_plot(pt1,  width = 0.4, height = 0.99, x = 0.62, y = 0.0) +  
  draw_plot(pt2,  width = 0.6, height = 0.34, x = 0.03, y = 0.66) +
  draw_plot(pt3, width = 0.6, height = 0.34, x = 0.03, y = 0.33) + 
  draw_plot(pt4, width = 0.6, height = 0.34, x = 0.03, y = 0.0) +
        draw_plot_label(
    label = c("a", "b", "c", "d"),
    x = c(0.005, 0.005, 0.005, 0.65),
    y = c(0.999, 0.67, 0.34, 0.999))

ggsave2(plot = plot, "files/FigS1.jpg", height = 25, width = 40, units = "cm")

ggsave2(plot = plot, "files/FigS1.eps", height = 25, width = 40, units = "cm")

knitr::include_graphics("files/FigS1.jpg")
```

### Correlation

```{r}
cor <- mv %>% 
  dplyr::select(where(is.numeric)) %>% 
  cor(., method ="pearson")

cor %>% kable()

sf1 <- ~ {
  
  corrplot::corrplot(cor, method = "number", type = "upper")
}

fig <- list(sf1) %>% 
  plot_grid(plotlist = .)

fig %>% 
  ggsave2(plot = ., "files/FigSs1.jpg", units = "cm"
         , width = 15, height = 15)

fig %>% 
  ggsave2(plot = ., "files/FigSs1.eps", units = "cm"
         , width = 15, height = 15)

knitr::include_graphics("files/FigSs1.jpg")
```

## Objetivo Específico 2

> Mostrar el efecto de los abonos orgánicos compost y biol en la calidad del fruto de mango en madurez comercial

### Fruit firmness at commercial maturity (FFCM)

```{r}
trait <- "ffmc"
cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p2a <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit firmness at commercial maturity (kgf.cm^{-2})"
           , glab = "Biol"
           , ylimits = c(0, 6, 2)
           )

p2a
```

### Soluble solids content of the fruit at commercial maturity (SSCFCM)

```{r}
trait <- "ssfmc"
cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p2b <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Soluble solids content of the fruit at commercial maturity (brix^{o})"
           , ylimits = c(0, 18, 3)
           )

p2b
```

### Titratable acidity of the fruit at commercial maturity (TAFCM)

```{r}
trait <- "atfmc"
cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p2c <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Titratable acidity of the fruit at commercial maturity ('%')"
           , ylimits = c(0, 0.8, 0.2)
           )

p2c
```

### Fruit dehydration percentage at commercial maturity (FDPCM)

```{r}
trait <- "pdfmc"
cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p2d <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit dehydration at commercial maturity ('%')"
           , glab = "Biol"
           , ylimits = c(0, 8, 2)
           )

p2d
```

### Fruit pH at commercial maturity (FpHCM).

```{r}
trait <- "phfmc"
cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p2e <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit pH at commercial maturity"
           , ylimits = c(0, 6, 2)
           )

p2e
```

### Internal fruit color at commercial maturity (IFCCM).

```{r}
trait <- "cifmc"
cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

lmd <- paste({{trait}}, "~ composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p2f <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Internal fruit color at commercial maturity"
           , ylimits = c(0, 5, 1)
           )

p2f
```

### Figure 3

```{r}
legend <- cowplot::get_plot_component(p2a, 'guide-box-top', return_all = TRUE)

p2 <- list(p2a + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2b + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2c + theme(legend.position="none")
           , p2d + theme(legend.position="none")
           # , p2e + theme(legend.position="none")
           # , p2f + theme(legend.position="none")
           ) %>% 
  plot_grid(plotlist = ., ncol = 2
            , labels = "auto"
            ) 

fig <- plot_grid(legend, p2, ncol = 1, align = 'v', rel_heights = c(0.05, 1))

fig %>% 
  ggsave2(plot = ., "files/Fig-3.jpg"
         , units = "cm"
         , width = 25
         , height = 27
         )

fig %>% 
  ggsave2(plot = ., "files/Fig-3.eps"
         , units = "cm"
         , width = 25
         , height = 27
         )

knitr::include_graphics("files/Fig-3.jpg")
```

### Multivariate

```{r}
mv <- consumo %>% 
  group_by(composts, biol) %>% 
  summarise(across(where(is.numeric), ~ mean(., na.rm = T))) %>%   
  unite("treat", composts:biol, sep = "-") %>% 
  rename(Treat = treat
         ,FDPCM = pdfmc
         ,FFCM = ffmc
         ,IFCCM = cifmc
         ,SSCFCM = ssfmc
         ,FpHCM = phfmc
         ,TAFCM = atfmc
         ,FCMI = imf)
  
pca <- mv %>% 
  PCA(scale.unit = T, quali.sup = 1, graph = F) 

# summary

summary(pca, nbelements = Inf, nb.dec = 2)


f4a <- plot.PCA(x = pca, choix = "var"
                , cex=0.8
                )

f4b <- plot.PCA(x = pca, choix = "ind"
                , habillage = 1
                , invisible = c("ind")
                , cex=0.8
                , ylim = c(-3,3)
                ) 

```

### Figure 4

```{r}
fig <- list(f4a, f4b) %>% 
  plot_grid(plotlist = ., ncol = 2, nrow = 1
            , labels = "auto"
            , rel_widths = c(1, 1.5)
            )
fig %>% 
  ggsave2(plot = ., "files/Fig-4.jpg", units = "cm"
         , width = 25
         , height = 10
         )

fig %>% 
  ggsave2(plot = ., "files/Fig-4.eps", units = "cm"
         , width = 25
         , height = 10
         )

knitr::include_graphics("files/Fig-4.jpg")
```

### Principal components

```{r}
var <- get_pca_var(pca)

tmp <- tempfile(fileext = ".png")
ppi <- 300
png(tmp, width=8*ppi, height=8*ppi, res=ppi)
corrplot(var$cor, 
         method="number",
         tl.col="black", 
         tl.srt=45,)
graphics.off()

pt1 <- png::readPNG(tmp) %>%
  grid::rasterGrob(interpolate = TRUE)

pt2 <- fviz_eig(pca, 
                addlabels=TRUE,
                hjust = 0.05,
                barfill="white",
                barcolor ="darkblue",
                linecolor ="red") + 
  ylim(0, 100) + 
  labs(
    title = "PCA - percentage of explained variances",
    y = "Variance (%)") +
  theme_minimal()

pt3 <- fviz_contrib(pca,
                     choice = "var", 
                     axes = 1, 
                     top = 10,
                     fill="white",
                     color ="darkblue",
                     sort.val = "desc") +
  ylim(0, 20) + 
  labs(title = "Dim 1 - variables contribution") 

pt4 <- fviz_contrib(pca,
                     choice = "var", 
                     axes = 2, 
                     top = 10,
                     fill="white",
                     color ="darkblue",
                     sort.val = "desc") +
  ylim(0, 80) + 
  labs(title = "Dim 2 - variables contribution") 

plot <- ggdraw(xlim = c(0.0, 1.0), ylim = c(0, 1.0))+
  draw_plot(pt1,  width = 0.4, height = 0.99, x = 0.62, y = 0.0) +  
  draw_plot(pt2,  width = 0.6, height = 0.34, x = 0.03, y = 0.66) +
  draw_plot(pt3, width = 0.6, height = 0.34, x = 0.03, y = 0.33) + 
  draw_plot(pt4, width = 0.6, height = 0.34, x = 0.03, y = 0.0) +
        draw_plot_label(
    label = c("a", "b", "c", "d"),
    x = c(0.005, 0.005, 0.005, 0.65),
    y = c(0.999, 0.67, 0.34, 0.999))

ggsave2(plot = plot, "files/FigS2.jpg", height = 25, width = 40, units = "cm")

ggsave2(plot = plot, "files/FigS2.eps", height = 25, width = 40, units = "cm")

knitr::include_graphics("files/FigS2.jpg")
```

### Correlation

```{r}
cor <- mv %>% 
  dplyr::select(where(is.numeric)) %>% 
  cor(., method ="pearson")

cor %>% kable()

sf2 <- ~ {
  
  corrplot::corrplot(cor, method = "number", type = "upper")
}

fig <- list(sf2) %>% 
  plot_grid(plotlist = .)

fig %>% 
  ggsave2(plot = ., "files/FigSs2.jpg", units = "cm"
         , width = 15, height = 15)

fig %>% 
  ggsave2(plot = ., "files/FigSs2.eps", units = "cm"
         , width = 15, height = 15)

knitr::include_graphics("files/FigSs2.jpg")
```

# Datos metereológicos

```{r}
met <- range_read(ss = gs, sheet = "clima") %>% 
  mutate(date = as_date(Fecha))

str(met)
names(met)

max(met$PP)

scale <- 3

plot <- met %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = TMax, color = "Tmax (°C)"), size= 0.8) + 
  geom_line(aes(y = TMin, color = "Tmin (°C)"), size= 0.8) +
  geom_bar(aes(y = PP/scale)
            , stat="identity", size=.1, fill="blue", color="black", alpha=.4) +
  geom_line(aes(y = HR/scale, color = "HR (%)"), size = 0.8) +
  scale_color_manual("", values = c("skyblue", "red", "blue")) +
  scale_y_continuous(limits = c(0, 40)
                     , expand = c(0, 0)
                     , name = "Temperature (°C)"
                     , sec.axis = sec_axis(~ . * scale, name = "Precipitation (mm)")
                     ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y", name = NULL) +
  theme_minimal_grid() +
  theme(legend.position = "top")

plot %>% 
  ggsave2(plot = ., "files/weather.jpg", units = "cm"
         , width = 25, height = 15)

knitr::include_graphics("files/weather.jpg")
```

