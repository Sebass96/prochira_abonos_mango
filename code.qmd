---
title: "Abonos orgánicos en la calidad  del fruto de mango (Mangifera indica L). Var. Kent"
author: Henry Morocho; Sebastian Casas; Flavio Lozano-Isla
format:
  html:
    toc: true
    toc-location: left
    number-sections: true
    self-contained: true
    output-file: "ESM_1"
editor_options: 
  chunk_output_type: console
execute: 
  warning: false
  echo: true
---

# Setup

```{r}
#| label:  setup

library(emmeans)
library(rstatix)
library(corrplot)
library(multcomp)
library(dlookr)
library(car)
library(FSA)
source('https://inkaverse.com/setup.r')

session_info()
```

# Importar datos

```{r}
url <- "https://docs.google.com/spreadsheets/d/1cjWrS-EVcII85c-l_NuEfTpjhVMI156e8REM9GDVP_w/edit?gid=95386135#gid=95386135"

gs <- url %>% 
  as_sheets_id()

tratamiento <- gs %>% 
  range_read("tratamientos") %>% 
  rename_with(~ tolower(.))

rendimiento <- gs %>% 
  range_read("rendimiento") %>% 
  rename_with(~ tolower(.)) 

fisio <- gs %>% 
  range_read("fisio") %>% 
  rename_with(~ tolower(.)) %>% 
  merge(., tratamiento) %>% 
  select(tratamiento,compost, biol,everything()) %>% 
  merge(., rendimiento) %>% 
  mutate(across(tratamiento:nfrutos, ~ as.factor(.))) %>% 
  rename(treat = tratamiento
         , repetition = repeticion
         , composts = compost)

consumo <- gs %>% 
  range_read("consumo") %>% 
  rename_with(~ tolower(.)) %>%
  merge(., tratamiento) %>% 
  select(tratamiento,compost, biol,everything()) %>% 
  mutate(across(tratamiento:nfrutos, ~ as.factor(.))) %>% 
    rename(treat = tratamiento
         , repetition = repeticion
         , composts = compost
         , n_fruits = nfrutos)

glimpse(fisio)

glimpse(consumo)

```

# Data summary

```{r}
sm <- fisio %>% 
  group_by(treat) %>% 
  summarise(across(pcfmf:rpp, ~ sum(!is.na(.))))

sm <- consumo %>% 
  group_by(treat) %>% 
  summarise(across(pdfmc:imf, ~ sum(!is.na(.))))

sm

diagnose_outlier(fisio) %>% 
  filter(outliers_cnt > 0) 

diagnose_outlier(consumo) %>% 
  filter(outliers_cnt > 0)

```

# Objetivos

- Mostrar  el efecto de los abonos orgánicos compost y biol en la calidad del fruto de mango en madurez fisiológica

Fig1: ffmf, cifmf, phfmf.ssfmf, atfmf, msfmf

tab sup1: tabla de suplmentaria: md,dvs,dif sig

Fig2: PCA Variables y tratamientos, rendimiento

- Mostrar  el efecto de los abonos orgánicos compost y biol en la calidad del fruto de mango en madurez comercial

Fig3: pdfmc, ssfmc, atfmc, phfmc

tab sup1: tabla de suplmentaria: md,dvs,dif sig

Fig4: PCA Variables y tratamientos


### Objetivo. 1  ###

- Mostrar  el efecto de los abonos orgánicos compost y biol en la calidad del fruto de mango en madurez fisiológica

## Firmeza de fruto (ffmf)

```{r}

model <- fisio %>% 
  lm(ffmf ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

fisio %>% 
  plot_raw(x = "composts", y = "ffmf", group = "biol")

anova(model)

# mc <- emmeans(model, ~ treat) %>% 
#   cld(Letters = letters, reversed = T) %>% 
#   mutate(across(.group, trimws))

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p1 <- mc %>% 
  plot_smr(x = "composts"
           , y = "ffmf"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 15, 5)
           , ylab = "FFMF (Kgf)"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )

p1

```

## Tabla variable 1 ##

```{r}

sts <- Summarize(ffmf ~ composts*biol, data = fisio, digits = 2, na.rm = TRUE)

tb1 <- sts%>% 
  merge(., mc) %>% 
  select(composts, biol, mean, sd, min, max, groups) %>% 
  mutate(treat = paste(composts,"x", biol)) %>% 
   select(treat, everything()) %>% 
  rename(Treat = treat,
         Compost = composts,
         Biol = biol,
         Sig = groups)

# tb1 %>% write_sheet(ss = gs, sheet = "tb1")

```


## Color interno del fruto (cifmf)

```{r}

# Considerar si es una variable cualitativa o cuantitativa discreta

model <- fisio %>% 
  lm(cifmf ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

fisio %>% 
  normality(cifmf) #Normalidad

ncvTest(model) #Homogeneidad de varianzas

fisio %>% 
  plot_raw(x = "composts", y = "cifmf", group = "biol")

anova(model)

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p2 <- mc %>% 
  plot_smr(x = "composts"
           , y = "cifmf"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 3, 1)
           , ylab = "CIMF"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )
p2

```

## Potencia de hidrogeno del fruto (phfmf)

```{r}

model <- fisio %>% 
  lm(phfmf ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

fisio %>% 
  plot_raw(x = "composts", y = "phfmf", group = "biol")

anova(model)

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p3 <- mc %>% 
  plot_smr(x = "composts"
           , y = "phfmf"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 3, 1)
           , ylab = "PHFMF"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )
p3

```

## Solidos solubles del fruto (ssfmf)

```{r}

model <- fisio %>% 
  lm(ssfmf ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

ncvTest(model) #Homogeneidad de varianzas

fisio %>% 
  plot_raw(x = "composts", y = "ssfmf", group = "biol")

fisio %>%
  plot_outlier(diagnose_outlier(fisio) %>% 
                 filter(variables == "ssfmf") %>% 
                 select(variables) %>% 
                 unlist())

anova(model)

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p4 <- mc %>% 
  plot_smr(x = "composts"
           , y = "ssfmf"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 10, 2)
           , ylab = "SSFMF (ºbrix)"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )
p4

```

## Acidez titulable del fruto (atfmf)

```{r}

model <- fisio %>% 
  lm(atfmf ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

ncvTest(model) #Homogeneidad de varianzas

fisio %>% 
  plot_raw(x = "composts", y = "atfmf", group = "biol")

fisio %>%
  plot_outlier(diagnose_outlier(fisio) %>% 
                 filter(variables == "atfmf") %>% 
                 select(variables) %>% 
                 unlist())

anova(model)

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p5 <- mc %>% 
  plot_smr(x = "composts"
           , y = "atfmf"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 1.5, 0.5)
           , ylab = "ATFMF"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )
p5

```

## Materia seca del fruto (msfmf)

```{r}

model <- fisio %>% 
  lm(msfmf ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

ncvTest(model) #Homogeneidad de varianzas

fisio %>% 
  plot_raw(x = "composts", y = "msfmf", group = "biol")

anova(model)

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p6 <- mc %>% 
  plot_smr(x = "composts"
           , y = "msfmf"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 25, 5)
           , ylab = "MSFMF"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )
p6

```


## Figura 1

```{r}

list(p1, p2, p3, p4, p5, p6) %>% 
  plot_grid(plotlist = ., ncol = 2
            , labels = "auto"
            ) %>% 
  ggsave2(plot = ., "files/Fig-1.jpg"
         , units = "cm"
         , width = 21
         , height = 15
         , dpi = 200
         )

```

## Multivariate

```{r}

mv <- fisio %>% 
  group_by(treat) %>% 
  summarise(across(where(is.numeric), ~ mean(., na.rm = T))) %>% 
   rename(Treat = treat)

pca <- mv %>% 
  PCA(scale.unit = T, quali.sup = 1, graph = F) 


f2a <- plot.PCA(x = pca, choix = "var")

f2b <- plot.PCA(x = pca, choix = "ind"
                , habillage = 1
                , invisible = c("ind")
                , ylim = c(-3,3))


```

# Correlation

```{r}

M <- cor(mv[,-c(1)], method ="pearson")

corrplot(M, method = "number", type = "upper")


```


## Figura 2

```{r}

list(f2a, f2b) %>% 
  plot_grid(plotlist = ., ncol = 2, nrow = 1
            , labels = "auto"
            , rel_widths = c(1, 1.5)
            ) %>% 
  ggsave2(plot = ., "files/Fig-2.jpg", units = "cm"
         , width = 17
         , height = 7
         , dpi = 200)

```


### Obj. 2 ###

- Mostrar  el efecto de los abonos orgánicos compost y biol en la calidad del fruto de mango en madurez comercial

# Porcentaje deshidratación del fruto (pdfmc)

```{r}

model <- consumo %>% 
  lm(pdfmc ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

consumo %>% 
  plot_raw(x = "composts", y = "pdfmc", group = "biol")

anova(model)

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p7 <- mc %>% 
  plot_smr(x = "composts"
           , y = "pdfmc"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 8, 2)
           , ylab = "PDFMC"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )
p7

```

# Solidos solubles del fruto (ssfmc)

```{r}

model <- consumo %>% 
  lm(ssfmc ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

consumo %>% 
  plot_raw(x = "composts", y = "ssfmc", group = "biol")

anova(model)

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p8 <- mc %>% 
  plot_smr(x = "composts"
           , y = "ssfmc"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 18, 3)
           , ylab = "SSFMC (ºbrix)"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )
p8

```

# Acidez titulable del fruto (atfmc)

```{r}

model <- consumo %>% 
  lm(atfmc ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

consumo %>% 
  normality(atfmc) #Normalidad

ncvTest(model) #Homogeneidad de varianzas

consumo %>% 
  plot_raw(x = "composts", y = "atfmc", group = "biol")

consumo %>%
  plot_outlier(diagnose_outlier(consumo) %>% 
                 filter(variables == "atfmc") %>% 
                 select(variables) %>% 
                 unlist())

anova(model)

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p9 <- mc %>% 
  plot_smr(x = "composts"
           , y = "atfmc"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 0.8, 0.2)
           , ylab = "ATFMC"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )
p9


```

# Potencial de hidrógeno del fruto (phfmc)

```{r}

model <- consumo %>% 
  lm(phfmc ~ composts*biol, .)

plot_diag(model) %>% 
  plot_grid(plotlist = ., ncol = 2)

consumo %>% 
  normality(phfmc) #Normalidad

ncvTest(model) #Homogeneidad de varianzas

consumo %>% 
  plot_raw(x = "composts", y = "phfmc", group = "biol")

consumo %>%
  plot_outlier(diagnose_outlier(consumo) %>% 
                 filter(variables == "phfmc") %>% 
                 select(variables) %>% 
                 unlist())

anova(model)

mc <- agricolae::duncan.test(model, trt = c("composts", "biol")) %>% 
  pluck("groups") %>% 
  rownames_to_column("treat") %>% 
  separate(treat, c("composts", "biol"))

p10 <- mc %>% 
  plot_smr(x = "composts"
           , y = "phfmc"
           , group = "biol"
           , sig = "groups"
           , ylimits = c(0, 6, 2)
           , ylab = "PHFMC"
           , xlab = "Composts"
           , glab = "Biol"
           , color = T
           )
p10

```

## Figura 3

```{r}

list(p7, p8, p9, p10) %>% 
  plot_grid(plotlist = ., ncol = 2
            , labels = "auto"
            ) %>% 
  ggsave2(plot = ., "files/Fig-3.jpg"
         , units = "cm"
         , width = 21
         , height = 13
         , dpi = 200
         )
```

## Multivariate

```{r}

mv <- consumo %>% 
  group_by(treat) %>% 
  summarise(across(where(is.numeric), ~ mean(., na.rm = T))) %>% 
   rename(Treat = treat)

pca <- mv %>% 
  PCA(scale.unit = T, quali.sup = 1, graph = F) 


f4a <- plot.PCA(x = pca, choix = "var")

f4b <- plot.PCA(x = pca, choix = "ind"
                , habillage = 1
                , invisible = c("ind")
                , ylim = c(-3,3))

```

# Correlation

```{r}

M <- cor(mv[,-c(1)], method ="pearson")

corrplot(M, method = "number", type = "upper")

```

## Figura 4

```{r}

list(f4a, f4b) %>% 
  plot_grid(plotlist = ., ncol = 2, nrow = 1
            , labels = "auto"
            , rel_widths = c(1, 1.5)
            ) %>% 
  ggsave2(plot = ., "files/Fig-4.jpg", units = "cm"
         , width = 17
         , height = 7
         , dpi = 200)

```

