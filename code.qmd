---
title: "Impact of organic fertilizers on the quality of mango (Mangifera indica L.) var. 'Kent' during physiological maturity and commercial maturity"
format:
  html:
    toc: true
    toc-location: left
    number-sections: true
    self-contained: true
    output-file: "ESM_2"
editor_options: 
  chunk_output_type: console
execute: 
  warning: false
  echo: true
---

# Project Setup

```{r}
#| label:  setup

library(emmeans)
library(corrplot)
library(multcomp)
library(FSA)
library(factoextra)
library(corrplot)
library(car)
source('https://inkaverse.com/setup.r')

cat("Project: ", getwd(), "\n")
session_info()
```

# Import data

Data was imported from the field book evaluated during the 2022-2023 growing season. The evaluations focused on mango fruits of the ‘Kent’ variety at two stages: physiological maturity and commercial maturity.

```{r}
url <- "https://docs.google.com/spreadsheets/d/1cjWrS-EVcII85c-l_NuEfTpjhVMI156e8REM9GDVP_w/edit?gid=95386135#gid=95386135"

gs <- url %>% 
  as_sheets_id()

tratamiento <- gs %>% 
  range_read("tratamientos") %>% 
  rename_with(~ tolower(.))

rendimiento <- gs %>% 
  range_read("rendimiento") %>% 
  rename_with(~ tolower(.)) 

fisio <- gs %>% 
  range_read("fisio") %>% 
  rename_with(~ tolower(.)) %>% 
  merge(., tratamiento) %>% 
  dplyr::select(tratamiento,compost, biol,everything()) %>% 
  merge(., rendimiento) %>% 
  mutate(across(tratamiento:nfrutos, ~ as.factor(.))) %>% 
  rename(treat = tratamiento
         , repetition = repeticion
         , composts = compost)

str(fisio)

consumo <- gs %>% 
  range_read("consumo") %>% 
  rename_with(~ tolower(.)) %>%
  merge(., tratamiento) %>% 
  dplyr::select(tratamiento,compost, biol,everything()) %>% 
  mutate(across(tratamiento:nfrutos, ~ as.factor(.))) %>% 
    rename(treat = tratamiento
         , repetition = repeticion
         , composts = compost
         , n_fruits = nfrutos)

glimpse(consumo)
```

```{r}
rendimiento %>% kable(caption = "Yield related traits")

fisio %>% kable(caption = "Evaluation of fruits at fisiological maturity")

consumo %>% kable(caption = "Evaluation of fruits at commercial maturity")
```

# Data summary

Summary of the number of data points recorded for each treatment and evaluated variable.

```{r}
sm <- fisio %>% 
  group_by(treat) %>% 
  summarise(across(pcfmf:rpp, ~ sum(!is.na(.))))

sm

sm <- consumo %>% 
  group_by(treat) %>% 
  summarise(across(pdfmc:imf, ~ sum(!is.na(.))))

sm
```

# Meteorological data

Climatic conditions of the study area located in the Tambogrande district, Piura region.

```{r}
met <- range_read(ss = gs, sheet = "clima") %>% 
  mutate(date = as_date(Fecha))

scale <- 3

plot <- met %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = TMax, color = "Tmax (°C)"), size= 0.8) + 
  geom_line(aes(y = TMin, color = "Tmin (°C)"), size= 0.8) +
  geom_bar(aes(y = PP/scale)
            , stat="identity", size=.1, fill="blue", color="black", alpha=.4) +
  geom_line(aes(y = HR/scale, color = "HR (%)"), size = 0.8) +
  scale_color_manual("", values = c("skyblue", "red", "blue")) +
  scale_y_continuous(limits = c(0, 40)
                     , expand = c(0, 0)
                     , name = "Temperature (°C)"
                     , sec.axis = sec_axis(~ . * scale, name = "Precipitation (mm)")
                     ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y", name = NULL) +
  theme_minimal_grid() +
  theme(legend.position = "top")

plot %>% 
  ggsave2(plot = ., "submission/Figure_2.jpg", units = "cm"
         , width = 25, height = 15)

plot %>% 
  ggsave2(plot = ., "submission/Figure_2.eps", units = "cm"
         , width = 25, height = 15)

knitr::include_graphics("submission/Figure_2.jpg")
```

# Objetives

The objective of this study is to demonstrate the effect of organic fertilizers, specifically compost and biol, applied at the soil and foliar levels on the quality of mango fruit at physiological and commercial maturity.

## Specific Objective 1

Demonstrate the effect of organic fertilizers, specifically compost and biol, applied at the soil and foliar levels on the quality of mango fruit at physiological maturity.

### Fruit firmness at physiological maturity (FF_pm)

```{r}
trait <- "ffmf"

fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p1a <- mc %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit firmness at physiological maturity (kgf/cm^{2})"
           , glab = "Biol"
           # , ylimits = c(0, 14, 4)
           , type = "line"
           )

p1a

mc_1a <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p1_a <- mc_1a %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit firmness at physiological maturity (kgf/cm^{2})"
           , glab = "Biol"
           , ylimits = c(0, 15, 3)
           , type = "bar"
           )


# # Calcular el valor máximo (upper whisker) por grupo
# positions <-  rmout$data$clean %>%
#   group_by(composts, biol) %>%
#   summarise(y_pos = max(ffmf, na.rm = TRUE) + 0.3, .groups = "drop")
# 
# # Combinar con las letras del objeto mc
# mc_pos <- left_join(mc, positions, by = c("composts", "biol"))
# 
# # Gráfico
# p1a <- ggplot( rmout$data$clean, aes(x = factor(composts), y = ffmf, fill = factor(biol))) +
#   stat_boxplot(geom = "errorbar", width = 0.5, position = position_dodge(0.8)) +
#   geom_boxplot(width = 0.5, position = position_dodge(0.8)) +
#   geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8),
#               shape = 21, size = 1.8, alpha = 0.6, color = "black") +
#   geom_text(data = mc_pos,
#             aes(x = factor(composts), y = y_pos, label = group, fill = factor(biol)),
#             position = position_dodge(width = 0.8),
#             size = 4,
#             inherit.aes = FALSE) +
#   labs(x = "Composts", y = "Fruit firmness at physiological maturity (kgf/cm²)", fill = "Biol") +
#   theme_minimal() +
#   theme(legend.position = "top") +
#     theme(
#     panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
#     panel.background = element_blank()
#   )
```

### Percentage of fruit canopy cover at physiological maturity (PFCC_pm).

```{r}
trait <- "pcfmf"

fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p1b <- mc %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Percentage of fruit canopy cover at physiological maturity ('%')"
           # , ylimits = c(0, 3, 1)
           , glab = "Biol"
           , type = "line"
           ) 

p1b

mc_1b <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p1_b <- mc_1b %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Percentage of fruit canopy cover at physiological maturity ('%')"
           , glab = "Biol"
           , ylimits = c(0, 90, 15)
           , type = "bar"
           )
```

### Fruit pulp color at physiological maturity (FPC_pm)

```{r}
trait <- "cifmf"

fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p1c <- mc %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit pulp color at physiological maturity"
           # , ylimits = c(0, 3, 1)
           , glab = "Biol"
           , type = "line"
           ) 
  # geom_text_repel(data = mc,
  #               aes(x = composts, y = emmean, label = group, group = biol),
  #               size = 3.5,
  #               max.overlaps = Inf, # para mostrar todas las letras
  #               box.padding = 0.3,
  #               point.padding = 0.2,
  #               segment.color = "grey50",
  #               segment.size = 0.2,
  #               colour = "black") +
  # geom_text(color = )

p1c

mc_1c <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p1_c <- mc_1c %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit pulp color at physiological maturity"
           , glab = "Biol"
           , ylimits = c(0, 3, 1)
           , type = "bar"
           )
```

### Fruit pH at physiological maturity  (FpH_pm)

```{r}
trait <- "phfmf"

fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

# p1c <- mc %>% 
#   plot_smr(x = "composts"
#            , y = "emmean"
#            , group = "biol"
#            , sig = "group"
#            , error = "SE"
#            , color = T
#            , xlab = "Composts"
#            , ylab = "Fruit pH at physiological maturity"
#            # , ylimits = c(0, 4, 1)
#            , type = "line"
#            )
# 
# p1d
```

### Soluble solids content of the fruit at physiological maturity (SSCF_pm)

```{r}
trait <- "ssfmf"

fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p1d <- mc %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Soluble solids content of the fruit at physiological maturity (brix^{o})"
           , glab = "Biol"
           #, ylimits = c(0, 4, 1)
           , type = "line"
           )

p1d

mc_1d <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p1_d <- mc_1d %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Soluble solids content of the fruit at physiological maturity (brix^{o})"
           , glab = "Biol"
           , ylimits = c(0, 10, 2)
           , type = "bar"
           )
```

### Titratable acidity of the fruit at physiological maturity (TAF_pm)

```{r}
trait <- "atfmf"

fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p1e <- mc %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Titratable acidity of the fruit at physiological maturity ('%')"
           , glab = "Biol"
           #
           , type = "line"
           )

p1e

mc_1e <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p1_e <- mc_1e %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Titratable acidity of the fruit at physiological maturity ('%')"
           , glab = "Biol"
           , ylimits = c(0, 1.5, 0.5)
           , type = "bar"
           )
```

### Fruit dry matter percentage at physiological maturity (FDMP_pm)

```{r}
trait <- "msfmf"

fb <- fisio

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p1f <- mc %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit dry matter at physiological maturity ('%')"
           , glab = "Biol"
           #
           , type = "line"
           )

p1f

mc_1f <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p1_f <- mc_1f %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit dry matter at physiological maturity ('%')"
           , glab = "Biol"
           , ylimits = c(0, 24, 6)
           , type = "bar"
           )
```

### Figure 3

Univariate analysis of the variables for determining the physiological maturity of the fruit at harvest time and for preventing handling damage during commercialization or industrial processes.

```{r}
legend <- cowplot::get_plot_component(p1a, 'guide-box-top', return_all = TRUE)

p1 <- list(p1a + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1b + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1c + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1d + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1e + theme(legend.position="none")
           , p1f + theme(legend.position="none")
           ) %>% 
  plot_grid(plotlist = ., ncol = 2
            , labels = "auto"
            ) 

fig <- plot_grid(legend, p1, ncol = 1, align = 'v', rel_heights = c(0.05, 1))
  
fig %>% 
  ggsave2(plot = ., "submission/Figure_3.jpg"
         , units = "cm"
         , width = 35
         , height = 38
         )

fig %>% 
  ggsave2(plot = ., "submission/Figure_3.eps"
         , units = "cm"
         , width = 35
         , height = 38
         )

knitr::include_graphics("submission/Figure_3.jpg")
```

### Supplementary Figure 1

Univariate analysis of the variables for determining the physiological maturity of the fruit at harvest time and for preventing handling damage during commercialization or industrial processes.

```{r}
legend <- cowplot::get_plot_component(p1_a, 'guide-box-top', return_all = TRUE)

p1 <- list(p1_a + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1_b + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1_c + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1_d + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1_e + theme(legend.position="none")
           , p1_f + theme(legend.position="none")
           ) %>% 
  plot_grid(plotlist = ., ncol = 2
            , labels = "auto"
            ) 

fig <- plot_grid(legend, p1, ncol = 1, align = 'v', rel_heights = c(0.05, 1))
  
fig %>% 
  ggsave2(plot = ., "submission/Figure_S1.jpg"
         , units = "cm"
         , width = 35
         , height = 38
         )

fig %>% 
  ggsave2(plot = ., "submission/Figure_S1.eps"
         , units = "cm"
         , width = 35
         , height = 38
         )

knitr::include_graphics("submission/Figure_S1.jpg")
```

### Multivariate analysis

Principal Component Analysis (PCA) of quality traits to correlate with mango fruits at physiological maturity from compost and biol applications.

```{r}
mv <- fisio %>% 
  select(-rpp) %>% 
  group_by(composts, biol) %>% 
  summarise(across(where(is.numeric), ~ mean(., na.rm = T))) %>%   
  unite("treat", composts:biol, sep = "-") %>% 
  rename(Treat = treat
         ,PFCC_pm = pcfmf
         ,FF_pm = ffmf
         ,FPC_pm = cifmf
         ,SSCF_pm = ssfmf
         ,FpH_pm = phfmf
         ,TAF_pm = atfmf
         ,FDMP_pm = msfmf
         ,FPMI = imf) %>% 
  mutate(Treat = case_when(Treat == "0-0" ~ "T0",
                           Treat == "0-5" ~ "T1",
                           Treat == "0-10" ~ "T2",
                           Treat == "5-0" ~ "T3",
                           Treat == "5-5" ~ "T4",
                           Treat == "5-10" ~ "T5",
                           Treat == "15-0" ~ "T6",
                           Treat == "15-5" ~ "T7",
                           Treat == "15-10" ~ "T8")) %>% 
  column_to_rownames(var = "Treat")

pca <- mv %>% 
  PCA(scale.unit = T, graph = F) 

# summary

summary(pca, nbelements = Inf, nb.dec = 2)


f2a <- fviz_pca_var(pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
)

# plot.PCA(x = pca, choix = "var"
#                 , cex=0.5
#                 )

f2b <- fviz_pca_ind(pca,
                axes = c(1,2),
                geom.ind = "text",
                repel = FALSE,
             , habillage = 1) +
  theme(legend.position = "none")

# plot.PCA(x = pca, choix = "ind"
#                 , habillage = 1
#                 , invisible = c("ind")
#                 , cex=0.8
#                 , ylim = c(-3,3)
#                 ) 
```

### Figure 4

Principal Component Analysis (PCA).

```{r}
fig <- list(f2a, f2b) %>% 
  plot_grid(plotlist = ., ncol = 2, nrow = 1
            , labels = "auto"
            , rel_widths = c(1.2, 1.1)
            )

fig %>% 
  ggsave2(plot = ., "submission/Figure_4.jpg", units = "cm"
         , width = 28
         , height = 13
         )

fig %>% 
  ggsave2(plot = ., "submission/Figure_4.eps", units = "cm"
         , width = 28
         , height = 13
         )

knitr::include_graphics("submission/Figure_4.jpg")
```

### Supplementary Figure 3

Results of the contributions and correlation of the variables in the Principal Component Analysis (PCA).

```{r}
var <- get_pca_var(pca)

pt1 <- fviz_eig(pca, 
                addlabels=TRUE,
                hjust = 0.05,
                barfill="white",
                barcolor ="darkblue",
                linecolor ="red") + 
  ylim(0, 90) + 
  labs(
    title = "PCA - percentage of explained variances",
    y = "Variance (%)") +
  theme_minimal()

pt2 <- fviz_contrib(pca,
                     choice = "var", 
                     axes = 1, 
                     top = 10,
                     fill="white",
                     color ="darkblue",
                     sort.val = "desc") +
  ylim(0, 15) + 
  labs(title = "Dim 1 - variables contribution") 

pt3 <- fviz_contrib(pca,
                     choice = "var", 
                     axes = 2, 
                     top = 10,
                     fill="white",
                     color ="darkblue",
                     sort.val = "desc") +
  ylim(0, 80) + 
  labs(title = "Dim 2 - variables contribution") 


pt4 <- ~ {
  
  corrplot(var$cor, 
         method="number",
         tl.col="black", 
         tl.srt=45,)
  
}


plot <- list(pt1, pt2, pt3) %>% 
  plot_grid(plotlist = ., ncol = 1, labels = "auto") %>% 
  list(., pt4) %>% 
  plot_grid(plotlist = ., ncol = 2, labels = c("", "d"))


ggsave2(plot = plot, "submission/Fig_S3.jpg", height = 20, width = 26, units = "cm")

ggsave2(plot = plot, "submission/Fig_S3.eps", height = 20, width = 26, units = "cm")

knitr::include_graphics("submission/Fig_S3.jpg")
```

## Specific Objective 2

Demonstrate the effect of organic fertilizers, specifically compost and biol, applied at the soil and foliar levels on the quality of mango fruit at commercial maturity.

### Fruit firmness at commercial maturity (FFCM)

```{r}
trait <- "ffmc"

cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p2a <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit firmness at commercial maturity (kgf/cm^{2})"
           , glab = "Biol"
           # , ylimits = c(0, 6, 2)
           , type = "line"
           ) 

p2a

mc_2a <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p2_a <- mc_2a %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit firmness at commercial maturity (kgf/cm^{2})"
           , glab = "Biol"
           , ylimits = c(0, 5, 1)
           , type = "bar"
           )
```

### Soluble solids content of the fruit at commercial maturity (SSCFCM)

```{r}
trait <- "ssfmc"

cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p2b <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Soluble solids content of the fruit at commercial maturity (brix^{o})"
           # , ylimits = c(0, 18, 3)
           , type = "line"
           )

p2b

mc_2b <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p2_b <- mc_2b %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Soluble solids content of the fruit at commercial maturity (brix^{o})"
           , glab = "Biol"
           , ylimits = c(0, 18, 6)
           , type = "bar"
           )
```

### Titratable acidity of the fruit at commercial maturity (TAFCM)

```{r}
trait <- "atfmc"

cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p2c <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Titratable acidity of the fruit at commercial maturity ('%')"
           # , ylimits = c(0, 0.8, 0.2)
           , type = "line"
           ) 

p2c

mc_2c <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p2_c <- mc_2c %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Titratable acidity of the fruit at commercial maturity ('%')"
           , glab = "Biol"
           , ylimits = c(0, 0.8, 0.2)
           , type = "bar"
           )
```

### Fruit dehydration percentage at commercial maturity (FDPCM)

```{r}
trait <- "pdfmc"

cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p2d <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit dehydration at commercial maturity ('%')"
           , glab = "Biol"
           # , ylimits = c(0, 8, 2)
           , type = "line"
           )

p2d

mc_2d <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p2_d <- mc_2d %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit dehydration at commercial maturity ('%')"
           , glab = "Biol"
           , ylimits = c(0, 8, 2)
           , type = "bar"
           )
```

### Fruit pH at commercial maturity (FpHCM)

```{r}
trait <- "phfmc"

cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p2e <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit pH at commercial maturity"
           # , ylimits = c(0, 6, 2)
           , type = "line"
           )

p2e

mc_2e <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p2_e <- mc_2e %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit pH at commercial maturity"
           , glab = "Biol"
           , ylimits = c(0, 5.5, 1)
           , type = "bar"
           )
```

### Fruit pulp color at commercial maturity (IFCCM)

```{r}
trait <- "cifmc"

cs <- consumo

lmm <- paste({{trait}}, "~ 1 + (1|repetition) + composts*biol") %>% as.formula()

rmout <- cs %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

plot_diagnostic(rmout$data$clean, formula = lmm) %>% 
  plot_grid(plotlist = ., ncol = 2)

rmout$outliers

model <- rmout$data$clean %>% 
  lmer(formula = lmm, .)

Anova(model, type = 3, test.statistic = "F")

mc1 <- emmeans(model, ~ biol|composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  rename(sig1 = ".group")

mc2 <- emmeans(model, ~ composts|biol) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.))) %>% 
  mutate(across(".group", ~ toupper(.))) %>% 
  rename(sig2 = ".group")

mc <- merge(mc1, mc2) %>% 
  unite(col = "group", c("sig1", "sig2"), sep = "")

mc %>% kable()

p2f <- mc %>% 
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit pulp color at commercial maturity"
           # , ylimits = c(0, 5, 1)
           , type = "line"
           )

p2f

mc_2f <- emmeans(model, ~ biol*composts) %>%
  cld(Letters = letters, reversed = T) %>% 
  mutate(across(".group", ~ trimws(.)))

p2_f <- mc_2f %>%
  plot_smr(x = "composts"
           , y = "emmean"
           , group = "biol"
           , sig = ".group"
           , error = "SE"
           , color = T
           , xlab = "Composts"
           , ylab = "Fruit pH at commercial maturity"
           , glab = "Biol"
           , ylimits = c(0, 4.5, 1)
           , type = "bar"
           )
```

### Figure 5

Univariate analysis of the most crucial variables for determining the commercial maturity of the fruit in the postharvest handling process.

```{r}
legend <- cowplot::get_plot_component(p2a, 'guide-box-top', return_all = TRUE)

p2 <- list(p2a + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2b + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2c + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2d + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2e + theme(legend.position="none")
           , p2f + theme(legend.position="none")
           ) %>% 
  plot_grid(plotlist = ., ncol = 2
            , labels = "auto"
            ) 

fig <- plot_grid(legend, p2, ncol = 1, align = 'v', rel_heights = c(0.05, 1))

fig %>% 
  ggsave2(plot = ., "submission/Figure_5.jpg"
         , units = "cm"
         , width = 35
         , height = 38
         )

fig %>% 
  ggsave2(plot = ., "submission/Figure_5.eps"
         , units = "cm"
         , width = 35
         , height = 38
         )

knitr::include_graphics("submission/Figure_5.jpg")
```

### Supplementary Figure 2

Univariate analysis of the most crucial variables for determining the commercial maturity of the fruit in the postharvest handling process.

```{r}
legend <- cowplot::get_plot_component(p2a, 'guide-box-top', return_all = TRUE)

p2 <- list(p2_a + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2_b + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2_c + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2_d + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p2_e + theme(legend.position="none")
           , p2_f + theme(legend.position="none")
           ) %>% 
  plot_grid(plotlist = ., ncol = 2
            , labels = "auto"
            ) 

fig <- plot_grid(legend, p2, ncol = 1, align = 'v', rel_heights = c(0.05, 1))

fig %>% 
  ggsave2(plot = ., "submission/Figure_S2.jpg"
         , units = "cm"
         , width = 35
         , height = 38
         )

fig %>% 
  ggsave2(plot = ., "submission/Figure_S2.eps"
         , units = "cm"
         , width = 35
         , height = 38
         )

knitr::include_graphics("submission/Figure_S2.jpg")
```

### Multivariate analysis

Principal Component Analysis (PCA) of quality characteristics to correlate with mango fruits at commercial maturity from compost and biol applications.

```{r}
mv <- consumo %>% 
  group_by(composts, biol) %>% 
  summarise(across(where(is.numeric), ~ mean(., na.rm = T))) %>%   
  unite("treat", composts:biol, sep = "-") %>% 
  rename(Treat = treat
         ,FDP_cm = pdfmc
         ,FF_cm = ffmc
         ,FPC_cm = cifmc
         ,SSCF_cm = ssfmc
         ,FpH_cm = phfmc
         ,TAF_cm = atfmc
         ,FCMI = imf) %>% 
  mutate(Treat = case_when(Treat == "0-0" ~ "T0",
                           Treat == "0-5" ~ "T1",
                           Treat == "0-10" ~ "T2",
                           Treat == "5-0" ~ "T3",
                           Treat == "5-5" ~ "T4",
                           Treat == "5-10" ~ "T5",
                           Treat == "15-0" ~ "T6",
                           Treat == "15-5" ~ "T7",
                           Treat == "15-10" ~ "T8")) %>% 
  column_to_rownames(var = "Treat")
  
pca <- mv %>% 
  PCA(scale.unit = T, graph = F) 

# summary

summary(pca, nbelements = Inf, nb.dec = 2)


f4a <- fviz_pca_var(pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
)

# plot.PCA(x = pca, choix = "var"
#                 , cex=0.5
#                 )

f4b <- fviz_pca_ind(pca,
                axes = c(1,2),
                geom.ind = "text",
                repel = FALSE,
             , habillage = 1) +
  theme(legend.position = "none") +
  ylim(c(-3,3))
```

### Figure 6

Principal Component Analysis (PCA).

```{r}
fig <- list(f4a, f4b) %>% 
  plot_grid(plotlist = ., ncol = 2, nrow = 1
            , labels = "auto"
            , rel_widths = c(1.2, 1.05)
            )
fig %>% 
  ggsave2(plot = ., "submission/Figure_6.jpg", units = "cm"
         , width = 28
         , height = 13
         )

fig %>% 
  ggsave2(plot = ., "submission/Figure_6.eps", units = "cm"
         , width = 28
         , height = 13
         )

knitr::include_graphics("submission/Figure_6.jpg")
```

### Supplementary Figure 4

Results of the contributions and correlation of the variables in the Principal Component Analysis (PCA).

```{r}
var <- get_pca_var(pca)

pt1 <- fviz_eig(pca, 
                addlabels=TRUE,
                hjust = 0.05,
                barfill="white",
                barcolor ="darkblue",
                linecolor ="red") + 
  ylim(0, 100) + 
  labs(
    title = "PCA - percentage of explained variances",
    y = "Variance (%)") +
  theme_minimal()

pt2 <- fviz_contrib(pca,
                     choice = "var", 
                     axes = 1, 
                     top = 10,
                     fill="white",
                     color ="darkblue",
                     sort.val = "desc") +
  ylim(0, 20) + 
  labs(title = "Dim 1 - variables contribution") 

pt3 <- fviz_contrib(pca,
                     choice = "var", 
                     axes = 2, 
                     top = 10,
                     fill="white",
                     color ="darkblue",
                     sort.val = "desc") +
  ylim(0, 80) + 
  labs(title = "Dim 2 - variables contribution") 


pt4 <- ~ {
  
  corrplot(var$cor, 
         method="number",
         tl.col="black", 
         tl.srt=45,)
  
}


plot <- list(pt1, pt2, pt3) %>% 
  plot_grid(plotlist = ., ncol = 1, labels = "auto") %>% 
  list(., pt4) %>% 
  plot_grid(plotlist = ., ncol = 2, labels = c("", "d"))

ggsave2(plot = plot, "submission/Fig_S4.jpg", height = 16, width = 25, units = "cm")

ggsave2(plot = plot, "submission/Fig_S4.eps", height = 16, width = 25, units = "cm")

knitr::include_graphics("submission/Fig_S4.jpg")
```

Climatic conditions of the study area located in the Tambogrande district, Piura region.

```{r}
met <- range_read(ss = gs, sheet = "clima") %>% 
  mutate(date = as_date(Fecha))

scale <- 3

plot <- met %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = TMax, color = "Tmax (°C)"), size= 0.8) + 
  geom_line(aes(y = TMin, color = "Tmin (°C)"), size= 0.8) +
  geom_bar(aes(y = PP/scale)
            , stat="identity", size=.1, fill="blue", color="black", alpha=.4) +
  geom_line(aes(y = HR/scale, color = "HR (%)"), size = 0.8) +
  scale_color_manual("", values = c("skyblue", "red", "blue")) +
  scale_y_continuous(limits = c(0, 40)
                     , expand = c(0, 0)
                     , name = "Temperature (°C)"
                     , sec.axis = sec_axis(~ . * scale, name = "Precipitation (mm)")
                     ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y", name = NULL) +
  theme_minimal_grid() +
  theme(legend.position = "top")

plot %>% 
  ggsave2(plot = ., "submission/weather.jpg", units = "cm"
         , width = 25, height = 15)

knitr::include_graphics("submission/weather.jpg")
```

